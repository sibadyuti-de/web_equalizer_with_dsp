<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EQ + DSP MP3 Player</title>
  <style>
    :root {
      --bg: #0f1220;
      --panel: #171a2b;
      --accent: #6aa1ff;
      --accent-2: #8ef;
      --text: #eef1ff;
      --muted: #9aa3b2;
      --shadow: 0 10px 30px rgba(0, 0, 0, .35);
      --radius: 16px;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      scrollbar-width: thin;
    }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 80% -20%, #1c2244 0%, #0f1220 35%, #0b0e18 100%);
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      width: 100%;
      overflow-y: auto;
    }

    header {
      padding: 10px clamp(16px, 4vw, 20px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    header h1 {
      font-size: clamp(18px, 3vw, 24px);
      margin: 0;
      letter-spacing: .3px;
    }

    .filebar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .button,
    button,
    input[type="file"]::file-selector-button {
      appearance: none;
      background: linear-gradient(180deg, #273056, #1a2142);
      color: var(--text);
      border: 1px solid #38406f;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    .button.secondary {
      background: #12162a;
      border-color: #2b355f;
      font-weight: 500;
    }

    .button.ghost {
      background: transparent;
      border-color: #2b355f;
      box-shadow: none;
    }

    .button:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    main {
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: clamp(14px, 3vw, 20px);
      padding: clamp(14px, 3vw, 20px);
      overflow: hidden;
    }

    @media (max-width: 1024px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: linear-gradient(180deg, rgba(255, 255, 255, .03), rgba(0, 0, 0, .08));
      border: 1px solid #273056;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: clip;
    }

    /* Player */
    .player {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    .player .meta {
      display: grid;
      grid-template-columns: 64px 1fr auto;
      gap: 16px;
      align-items: center;
      padding: 18px 18px 0 18px;
    }

    .cover {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      background: #12162a;
      display: grid;
      place-items: center;
      border: 1px solid #26305b;
    }
  </style>
</head>

<body>
  <header>
    <h1>ðŸŽ§ Web Audio EQ + DSP Player</h1>
    <div class="filebar">
      <input id="file" type="file" accept="audio/mpeg,audio/mp3,audio/*" autocomplete="off"/>
      <button id="play" class="button" disabled>Play</button>
      <button id="pause" class="button secondary" disabled>Pause</button>
      <button id="bypass" class="button ghost" title="Bypass all effects (hotkey: B)">Bypass</button>
    </div>
  </header>

  <main>
    <section class="panel player">
      <div class="meta">
        <div class="cover" aria-hidden>
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10" />
            <polygon points="10 8 16 12 10 16 10 8" />
          </svg>
        </div>
        <div>
          <div class="title" id="title">Load an MP3</div>
          <div class="subtitle" id="subtitle">Local file â€¢ 44.1â€“48 kHz</div>
        </div>
        <div>
          <select id="preset" class="button secondary" title="EQ Presets">
            <option value="flat">Preset: Flat</option>
            <option value="bass">Bass Boost</option>
            <option value="treble">Treble Boost</option>
            <option value="vshape">V-Shape</option>
            <option value="vocal">Vocal Clarity</option>
            <option value="loudness">Loudness</option>
          </select>
        </div>
      </div>

      <div class="visualizer">
        <canvas id="scope" height="220"></canvas>
      </div>

      <div class="transport">
        <span id="cur">0:00</span>
        <input id="seek" class="range" type="range" min="0" max="1" step="0.001" value="0" />
        <span id="dur">0:00</span>
      </div>
    </section>

    <section class="panel controls">
      <div class="head">
        <strong>Equalizer & Effects</strong>
        <div style="display:flex; gap:8px; align-items:center;">
          <label class="button ghost" style="display:flex;gap:8px;align-items:center;">
            Preamp
            <input id="preamp" type="range" min="-12" max="12" step="0.1" value="0" style="width:120px;" />
          </label>
          <button id="reset" class="button secondary">Reset</button>
        </div>
      </div>
      <div class="grid">
        <div class="card" style="grid-column: 1 / -1;">
          <h4>10â€‘Band Graphic EQ (Â±12 dB)</h4>
          <div id="eq" class="eqwrap" aria-label="Equalizer Bands"></div>
        </div>

        <div class="card">
          <h4>Compressor</h4>
          <div class="toggles">
            <div class="control">
              <label for="comp-enable">Enable</label>
              <input id="comp-enable" type="checkbox" checked>
            </div>

            <div class="control">
              <label for="comp-thr">Threshold</label>
              <input id="comp-thr" type="range" min="-100" max="0" step="1" value="-24">
            </div>

            <div class="control">
              <label for="comp-ratio">Ratio</label>
              <input id="comp-ratio" type="range" min="1" max="20" step="1" value="4">
            </div>

            <div class="control">
              <label for="comp-attack">Attack</label>
              <input id="comp-attack" type="range" min="0" max="1" step="0.001" value="0.003">
            </div>

            <div class="control">
              <label for="comp-release">Release</label>
              <input id="comp-release" type="range" min="0" max="1" step="0.001" value="0.25">
            </div>
          </div>
        </div>

        <div class="card">
          <h4>Reverb</h4>
          <div class="toggles">
            <div class="control">
              <label for="reverb-enable">Enable</label>
              <input id="reverb-enable" type="checkbox">
            </div>

            <div class="control">
              <label for="reverb-mix">Mix</label>
              <input id="reverb-mix" type="range" min="0" max="1" step="0.01" value="0.2">
            </div>

            <div class="control">
              <label for="reverb-decay">Decay (s)</label>
              <input id="reverb-decay" type="range" min="0.1" max="6" step="0.1" value="2.5">
            </div>
          </div>
        </div>

        <div class="card">
          <h4>Bass & Presence</h4>
          <div class="toggles">
            <div class="control">
              <label for="bass-enable">Bass Shelf</label>
              <input id="bass-enable" type="checkbox">
            </div>

            <div class="control">
              <label for="bass-gain">Gain (dB)</label>
              <input id="bass-gain" type="range" min="-12" max="12" step="0.1" value="6">
            </div>

            <div class="control">
              <label for="presence">Presence (4 kHz)</label>
              <input id="presence" type="range" min="-6" max="6" step="0.1" value="1.5">
            </div>
          </div>
        </div>

        <div class="card">
          <h4>Utilities</h4>
          <div class="toggles">
            <div class="control">
              <label for="bypass2">Bypass All</label>
              <input id="bypass2" type="checkbox">
            </div>

            <div class="control">
              <label for="balance">L/R Balance</label>
              <input id="balance" type="range" min="-1" max="1" step="0.01" value="0">
            </div>

            <div class="control">
              <label for="trim">Gain Trim (dB)</label>
              <input id="trim" type="range" min="-24" max="12" step="0.1" value="0">
            </div>

            <div class="control" style="flex-direction: row; gap: 8px; flex-wrap: wrap;">
              <button id="savePreset" class="button">Save Preset</button>
              <button id="loadPreset" class="button secondary">Load Preset</button>
              <input id="presetFile" type="file" accept="application/json" hidden />
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <footer>
    Drag & drop an MP3 anywhere â€¢ Hotkeys: <span class="kbd">Space</span> Play/Pause, <span class="kbd">B</span> Bypass,
    <span class="kbd">R</span> Reset â€¢ Made with â™¥ By Siba
  </footer>

  <audio id="audio" crossorigin="anonymous"></audio>

</body>
<script>
  // ===== Web Audio setup =====
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioCtx();
let source = null; // MediaElementSource

const audio = document.getElementById("audio");
const scope = document.getElementById("scope");
const c = scope.getContext("2d");

const playBtn = document.getElementById("play");
const pauseBtn = document.getElementById("pause");
const seek = document.getElementById("seek");
const cur = document.getElementById("cur");
const dur = document.getElementById("dur");
const titleEl = document.getElementById("title");
const bypassBtn = document.getElementById("bypass");

const presetSel = document.getElementById("preset");
const preamp = document.getElementById("preamp");
const resetBtn = document.getElementById("reset");

const compEnable = document.getElementById("comp-enable");
const compThr = document.getElementById("comp-thr");
const compRatio = document.getElementById("comp-ratio");
const compAttack = document.getElementById("comp-attack");
const compRelease = document.getElementById("comp-release");

const revEnable = document.getElementById("reverb-enable");
const revMix = document.getElementById("reverb-mix");
const revDecay = document.getElementById("reverb-decay");

const bassEnable = document.getElementById("bass-enable");
const bassGain = document.getElementById("bass-gain");
const presence = document.getElementById("presence");

const bypass2 = document.getElementById("bypass2");
const balance = document.getElementById("balance");
const trim = document.getElementById("trim");

const savePresetBtn = document.getElementById("savePreset");
const loadPresetBtn = document.getElementById("loadPreset");
const presetFile = document.getElementById("presetFile");

// Node graph: media -> preGain -> [10x EQ] -> bass shelf(optional) -> presence peaking -> dynamics -> reverb mix -> balance -> analyser -> out
const preGain = ctx.createGain();
const eqBands = [];
const eqFrequencies = [32, 64, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
const eqMin = -12,
  eqMax = 12;

// Create 10 peaking filters
for (let i = 0; i < eqFrequencies.length; i++) {
  const f = ctx.createBiquadFilter();
  f.type = "peaking";
  f.frequency.value = eqFrequencies[i];
  f.Q.value = 1.0; // moderate bandwidth
  f.gain.value = 0;
  eqBands.push(f);
}

// Optional shelves / presence
const bassShelf = ctx.createBiquadFilter();
bassShelf.type = "lowshelf";
bassShelf.frequency.value = 100;
bassShelf.gain.value = 0;

const presencePeak = ctx.createBiquadFilter();
presencePeak.type = "peaking";
presencePeak.frequency.value = 4000;
presencePeak.Q.value = 1.0;
presencePeak.gain.value = 0;

// Compressor
const comp = ctx.createDynamicsCompressor();
comp.threshold.value = -24;
comp.ratio.value = 4;
comp.attack.value = 0.003;
comp.release.value = 0.25;

// Reverb via generated impulse (simple exponential decay noise)
const convolver = ctx.createConvolver();
const reverbGain = ctx.createGain();
const dryGain = ctx.createGain();
reverbGain.gain.value = 0.0; // mix control
dryGain.gain.value = 1.0;

function buildImpulse(decaySec = 2.5) {
  const rate = ctx.sampleRate;
  const length = Math.max(1, Math.floor(decaySec * rate));
  const impulse = ctx.createBuffer(2, length, rate);
  for (let ch = 0; ch < 2; ch++) {
    const data = impulse.getChannelData(ch);
    for (let i = 0; i < length; i++) {
      const t = i / length;
      data[i] = (Math.random() * 2 - 1) * Math.pow(1 - t, 3); // quick-ish decay
    }
  }
  convolver.buffer = impulse;
}
buildImpulse();

// Stereo balance
const splitter = ctx.createChannelSplitter(2);
const merger = ctx.createChannelMerger(2);
const leftGain = ctx.createGain();
const rightGain = ctx.createGain();
leftGain.gain.value = 1;
rightGain.gain.value = 1;

// Output stage
const trimGain = ctx.createGain();
trimGain.gain.value = 1.0;

// Visualizer
const analyser = ctx.createAnalyser();
analyser.fftSize = 2048;
const timeData = new Uint8Array(analyser.fftSize);

// Connect the static graph (everything except the media source)
function connectGraph() {
  // Start chain
  preGain.disconnect();
  preGain.connect(eqBands[0]);
  for (let i = 0; i < eqBands.length - 1; i++)
    eqBands[i].connect(eqBands[i + 1]);

  eqBands[eqBands.length - 1].connect(bassShelf);
  bassShelf.connect(presencePeak);

  // Dry / wet branches for reverb
  presencePeak.connect(dryGain);
  presencePeak.connect(convolver);
  convolver.connect(reverbGain);

  // Sum dry + wet into splitter for balance
  const sumNode = ctx.createGain();
  dryGain.connect(sumNode);
  reverbGain.connect(sumNode);

  sumNode.connect(splitter);
  splitter.connect(leftGain, 0);
  splitter.connect(rightGain, 1);
  leftGain.connect(merger, 0, 0);
  rightGain.connect(merger, 0, 1);

  // Dynamics compressor can sit before visualizer to show post-effects signal
  merger.connect(comp);
  comp.connect(trimGain);
  trimGain.connect(analyser);
  analyser.connect(ctx.destination);
}
connectGraph();

// ===== UI: EQ bands =====
const eqContainer = document.getElementById("eq");
const bandControls = [];
eqFrequencies.forEach((freq, idx) => {
  const wrap = document.createElement("div");
  wrap.className = "eqband";

  const slider = document.createElement("input");
  slider.type = "range";
  slider.min = eqMin;
  slider.max = eqMax;
  slider.step = 0.1;
  slider.value = 0;
  slider.setAttribute("aria-label", `${freq} Hz`);

  const label = document.createElement("label");
  label.textContent = freq >= 1000 ? freq / 1000 + "k" : freq;

  slider.addEventListener("input", () => {
    eqBands[idx].gain.value = parseFloat(slider.value);
  });

  wrap.appendChild(slider);
  wrap.appendChild(label);
  eqContainer.appendChild(wrap);
  bandControls.push(slider);
});

// ===== File loading =====
function loadFile(file) {
  const url = URL.createObjectURL(file);
  audio.src = url;
  audio.load();
  titleEl.textContent = file.name || "Unknown Title";
  playBtn.disabled = false;
  pauseBtn.disabled = false;
  if (!source) {
    source = ctx.createMediaElementSource(audio);
    source.connect(preGain);
  }
}

document.getElementById("file").addEventListener("change", (e) => {
  if (e.target.files[0]) loadFile(e.target.files[0]);
});

// Drag & drop
window.addEventListener("dragover", (e) => {
  e.preventDefault();
});
window.addEventListener("drop", (e) => {
  e.preventDefault();
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) loadFile(f);
});

// ===== Transport & time =====
playBtn.addEventListener("click", async () => {
  await ctx.resume();
  audio.play();
});
pauseBtn.addEventListener("click", () => audio.pause());

audio.addEventListener("timeupdate", () => {
  if (audio.duration) {
    seek.max = audio.duration;
    seek.value = audio.currentTime;
    cur.textContent = fmt(audio.currentTime);
    dur.textContent = fmt(audio.duration);
  }
});
seek.addEventListener("input", () => {
  audio.currentTime = seek.value;
});

function fmt(sec) {
  sec = Math.floor(sec || 0);
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return m + ":" + String(s).padStart(2, "0");
}

// ===== Bypass & reset =====
let bypassed = false;
function setBypass(state) {
  bypassed = state;
  if (!source) return;
  if (bypassed) {
    try {
      source.disconnect();
    } catch {}
    source.connect(ctx.destination);
    bypassBtn.textContent = "Bypassed";
  } else {
    try {
      source.disconnect();
    } catch {}
    source.connect(preGain);
    bypassBtn.textContent = "Bypass";
  }
}
bypassBtn.addEventListener("click", () => setBypass(!bypassed));
document
  .getElementById("bypass2")
  .addEventListener("change", (e) => setBypass(e.target.checked));

function resetAll() {
  bandControls.forEach((s, i) => {
    s.value = 0;
    eqBands[i].gain.value = 0;
  });
  preamp.value = 0;
  preGain.gain.value = dbToGain(0);
  trim.value = 0;
  trimGain.gain.value = dbToGain(0);
  bassEnable.checked = false;
  bassShelf.gain.value = 0;
  bassGain.value = 6;
  presence.value = 0;
  presencePeak.gain.value = 0;
  compEnable.checked = true;
  comp.threshold.value = -24;
  compThr.value = -24;
  comp.ratio.value = 4;
  compRatio.value = 4;
  comp.attack.value = 0.003;
  compAttack.value = 0.003;
  comp.release.value = 0.25;
  compRelease.value = 0.25;
  revEnable.checked = false;
  reverbGain.gain.value = 0;
  revMix.value = 0.2;
  revDecay.value = 2.5;
  buildImpulse(2.5);
  balance.value = 0;
  updateBalance(0);
  presetSel.value = "flat";
}
resetBtn.addEventListener("click", resetAll);

// ===== Knobs wiring =====
preamp.addEventListener(
  "input",
  () => (preGain.gain.value = dbToGain(parseFloat(preamp.value)))
);
trim.addEventListener(
  "input",
  () => (trimGain.gain.value = dbToGain(parseFloat(trim.value)))
);

compEnable.addEventListener("change", () => {
  if (compEnable.checked) {
    merger.disconnect();
    merger.connect(comp);
  } else {
    try {
      merger.disconnect();
    } catch {}
    merger.connect(trimGain);
  }
});
compThr.addEventListener(
  "input",
  () => (comp.threshold.value = parseFloat(compThr.value))
);
compRatio.addEventListener(
  "input",
  () => (comp.ratio.value = parseFloat(compRatio.value))
);
compAttack.addEventListener(
  "input",
  () => (comp.attack.value = parseFloat(compAttack.value))
);
compRelease.addEventListener(
  "input",
  () => (comp.release.value = parseFloat(compRelease.value))
);

revEnable.addEventListener("change", () => {
  reverbGain.gain.value = revEnable.checked ? parseFloat(revMix.value) : 0;
});
revMix.addEventListener("input", () => {
  if (revEnable.checked) reverbGain.gain.value = parseFloat(revMix.value);
});
revDecay.addEventListener("input", () =>
  buildImpulse(parseFloat(revDecay.value))
);

bassEnable.addEventListener(
  "change",
  () =>
    (bassShelf.gain.value = bassEnable.checked ? parseFloat(bassGain.value) : 0)
);
bassGain.addEventListener("input", () => {
  if (bassEnable.checked) bassShelf.gain.value = parseFloat(bassGain.value);
});
presence.addEventListener(
  "input",
  () => (presencePeak.gain.value = parseFloat(presence.value))
);

balance.addEventListener("input", () =>
  updateBalance(parseFloat(balance.value))
);
function updateBalance(val) {
  // val -1 = left only, 0 = center, 1 = right only
  const L = clamp(1 - Math.max(0, val), 0, 1);
  const R = clamp(1 + Math.min(0, val), 0, 1);
  leftGain.gain.value = L;
  rightGain.gain.value = R;
}

// ===== Presets =====
const presets = {
  flat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  bass: [6, 5, 4, 2, 0, -1, -1, 0, 1, 1],
  treble: [-2, -2, -1, 0, 0, 1, 2, 3, 4, 5],
  vshape: [4, 3, 2, 1, 0, 0, 0, 1, 3, 4],
  vocal: [-3, -2, -1, 1, 2, 3, 4, 2, 0, -1],
  loudness: [4, 3, 1, 0, 0, 0, 1, 2, 3, 4],
};
function applyPreset(key) {
  const arr = presets[key] || presets.flat;
  arr.forEach((g, i) => {
    bandControls[i].value = g;
    eqBands[i].gain.value = g;
  });
}
presetSel.addEventListener("change", () => applyPreset(presetSel.value));

savePresetBtn.addEventListener("click", () => {
  const gains = bandControls.map((s) => parseFloat(s.value));
  const data = {
    eq: gains,
    preamp: parseFloat(preamp.value),
    trim: parseFloat(trim.value),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: "application/json",
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "eq-preset.json";
  a.click();
});
loadPresetBtn.addEventListener("click", () => presetFile.click());
presetFile.addEventListener("change", async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const txt = await f.text();
  try {
    const json = JSON.parse(txt);
    if (Array.isArray(json.eq) && json.eq.length === 10) {
      json.eq.forEach((g, i) => {
        bandControls[i].value = g;
        eqBands[i].gain.value = g;
      });
    }
    if (typeof json.preamp === "number") {
      preamp.value = json.preamp;
      preGain.gain.value = dbToGain(json.preamp);
    }
    if (typeof json.trim === "number") {
      trim.value = json.trim;
      trimGain.gain.value = dbToGain(json.trim);
    }
  } catch (err) {
    alert("Invalid preset file");
  }
});

// ===== Visualizer render loop =====
function draw() {
  requestAnimationFrame(draw);
  const w = scope.clientWidth,
    h = scope.clientHeight;
  if (scope.width !== w) scope.width = w;
  if (scope.height !== h) scope.height = h;

  c.clearRect(0, 0, w, h);
  analyser.getByteTimeDomainData(timeData);

  // waveform
  c.globalAlpha = 0.9;
  c.lineWidth = 2;
  c.beginPath();
  for (let i = 0; i < timeData.length; i++) {
    const x = (i / (timeData.length - 1)) * w;
    const y = (timeData[i] / 255) * h;
    if (i === 0) c.moveTo(x, y);
    else c.lineTo(x, y);
  }
  c.strokeStyle = "#8ec9ff";
  c.stroke();

  // glow overlay
  const grad = c.createLinearGradient(0, 0, 0, h);
  grad.addColorStop(0, "rgba(110, 170, 255, .25)");
  grad.addColorStop(1, "rgba(110, 170, 255, 0)");
  c.fillStyle = grad;
  c.fillRect(0, 0, w, h);
}
draw();

// ===== Helpers & hotkeys =====
function dbToGain(db) {
  return Math.pow(10, db / 20);
}
function clamp(v, a, b) {
  return Math.max(a, Math.min(b, v));
}

document.addEventListener("keydown", (e) => {
  if (e.code === "Space") {
    e.preventDefault();
    audio.paused ? audio.play() : audio.pause();
  }
  if (e.key.toLowerCase() === "b") setBypass(!bypassed);
  if (e.key.toLowerCase() === "r") resetAll();
});

// Initialize defaults
resetAll();
</script>
</html>